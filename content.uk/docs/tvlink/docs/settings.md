---
title: Налаштування сервера та потоків
weight: 18
---

## Налаштування сервера

{{% hint info %}}
Ця інформація стосується налаштувань на сторінці «Settings».
{{% /hint %}}

<p align="center">
  <a href="/tvlink/settings/01.png"><img src="/tvlink/settings/01.png" width="480"/></a>
</p>

{{% hint info %}}
Для більшості налаштувань на цій сторінці, щоб зміни набули чинності, потрібно перечитати конфігурацію «TVLINK». Для цього є опція «Apply Settings» унизу сторінки.
Опції «Refresh sources at playlist» та «Remove broken channels» цього не потребують.
{{% /hint %}}

+ «Server port» – задає порт, на якому «TVLINK» приймає запити. Порт для потоків буде більший на одиницю: «Server port + 1».

+ «Playlist IP» – це адреса, яку «TVLINK» використовуватиме для плейлистів (коли опцію «Auto playlist IP» вимкнено). Адресу можна вибрати зі списку.

+ «Auto playlist IP» – якщо цю опцію ввімкнено, «TVLINK» використовуватиме ту IP-адресу в плейлисті, з якої надходить запит від клієнта.

+ «Check internet IP» – IP-адреса, за якою «TVLINK» перевіряє підключення до інтернету. За замовчуванням використовується адреса «8.8.8.8».
Якщо вам потрібно змінити цю адресу перед запуском програми, створіть файл «check-internet.ip» у каталозі tvlink і впишіть туди потрібну адресу.

+ «Check internet max time» – максимальний час, протягом якого «TVLINK» перевіряє підключення до інтернету. Програма не запуститься, доки не матиме доступу до інтернету.

+ «Refresh sources at startup» – оновлювати джерела під час запуску програми.

+ «Refresh sources at playlist» – оновлювати джерела під час запиту плейлиста.

+ «Create static playlist» – створює статичні файли плейлистів (основний та для профілів) у каталозі «tvlink/playlist» і видає їх на запит клієнтів.
Це значно пришвидшує роботу, коли ви маєте велику кількість каналів (100 і більше). Статичний плейлист створюється (оновлюється) кожного разу,
коли автоматично оновлюються джерела каналів, або коли ви натискаєте на «Update all sources/Create static playlist» на сторінці «Sources».
Для токенів (Authentication Token) статичні плейлисти не створюються.

+ «Remove broken channels» – «TVLINK» автоматично видалятиме всі канали, які виявилися непрацездатними.
Будьте обережні з цією опцією: якщо зникне підключення до інтернету, «TVLINK» почне видаляти кожен канал, який ви будете вмикати.

+ «Authentication webUI» – проста автентифікація (логін/пароль) для веб-інтерфейсу. Після активації ви одразу побачите вікно для введення даних.
Вам потрібно ввести – «admin/admin». Після цього ви можете вказати свої логін та пароль у полях «Login (webUI)» та «Password (webUI)» відповідно.
Якщо в полі «Login (webUI)» ввести порожній рядок або менше ніж три символи, логін буде скинуто до значення за замовчуванням (admin).
Це стосується і поля «Password (webUI)»: порожній рядок або менше ніж три символи скинуть пароль на «admin».

IP-адреси для списку «Playlist IP» беруться із системи.
Якщо вам потрібно додати IP-адресу (або доменне ім’я), якої немає в системі (наприклад, якщо «TVLINK» працює за NAT), створіть файл «ip-address.ext» у каталозі «tvlink/data».
Кожен рядок файлу повинен містити одну IP-адресу або одне доменне ім’я. Наприклад:

    100.100.100.100
    200.200.200.200
    my.own.server.com

## Маркер автентифікації для потоків та плейлистів

<p align="center">
  <a href="/tvlink/settings/02.png"><img src="/tvlink/settings/02.png" width="480"/></a>
</p>

Захист від несанкціонованого доступу до потоків та плейлистів.

+ «Authentication Token» – вмикає підтримку маркерів автентифікації.
+ «Main Token for playlist/streams» – будь-яка послідовність латинських літер та/або цифр, чутлива до регістру.

{{% hint info %}}
Після будь-яких змін у налаштуваннях «Токенів» необхідно застосувати налаштування («Apply Settings» внизу сторінки) або перезавантажити програму.

Якщо у вас увімкнена опція «Create static playlist», то після будь-яких змін у налаштуваннях «Токенів» не забудьте оновити статичні плейлисти (натисніть «Update all sources» на сторінці «Sources»).
{{% /hint %}}

Якщо опцію «Authentication Token» активовано, після застосування налаштувань доступ до потоків та плейлистів здійснюватиметься лише через токен. На сторінці «Settings» задається токен для основного плейлиста.

Інші токени задаються у розділі [«Профілі користувачів»](/docs/tvlink/docs/profiles).

## Періодичне перезавантаження налаштувань

<p align="center">
  <a href="/tvlink/settings/03.png"><img src="/tvlink/settings/03.png" width="480"/></a>
</p>

Ця функція перезавантажує налаштування «TVLINK» через вказані проміжки часу. Ця дія аналогічна натисканню кнопки «Apply Settings» внизу сторінки.
Вона не перезавантажує саму програму, а лише повторно ініціює всі налаштування. Однак це сприяє очищенню оперативної пам’яті та закриттю всіх мережевих з’єднань (сокетів).
Тому ця функція може бути корисною, коли сервер працює цілодобово.

+ «Reload by interval» – перезавантажувати модулі «TVLINK» через інтервал часу (у годинах), вказаний у параметрі «Reload every hours».
+ «Reload once a day» – перезавантажувати один раз на добу у час, визначений параметром «Reload at o’clock».

Час, вказаний у цих опціях, є орієнтовним. Наприклад, якщо встановлено «Reload once a day» / «Reload at o’clock» на 4 годині, перезавантаження відбудеться між четвертою та п’ятою годинами.

Опція «Reload once a day» має вищий пріоритет. Якщо ви ввімкнете обидва параметри, перезавантаження модулів відбуватиметься один раз на добу.

Перезавантаження відбуваються лише за наступних умов:

1. кількість відкритих мережевих з’єднань (сокетів) перевищує 10;
2. програма використовує більше ніж 60 МБ оперативної пам’яті для систем, де обсяг ОЗП менший за 1,5 ГБ, та більше ніж 120 МБ для систем, де обсяг ОЗП перевищує 1,5 ГБ;

Щоб уникнути проблем із трансляцією потоків, ці функції спрацьовують лише тоді, коли «TVLINK» не веде мовлення (немає підключених клієнтів).
Перезавантаження модулів відбудеться одразу після відключення останнього клієнта.

Якщо ввімкнено опцію «Ignore connected clients on Reload», модулі «TVLINK» буде перезавантажено незалежно від наявності підключених клієнтів.

## «Empty channel link»

Дозволяє ввести власне посилання на потік, який відтворюватиметься, якщо жодне з основних посилань на канал не працює.

## «Exclude these lines from channel names when mapping»

Виключення слів із назв каналів. Ви можете виключити будь-які рядки з назви каналу для автоматичного зв’язування.
Сама назва каналу при цьому залишається незмінною, проте «TVLINK» під час автоматичного зв’язування відкидатиме вказану вами частину з назви.
Роздільником слів, які потрібно виключити з назви, є кома (без пробілів).
Наприклад, при таких налаштуваннях усі канали з такими іменами вважатимуться одним і тим самим каналом – «Discovery Science HD».

    «Discovery Science HD»
    «Discovery Science HD orig»
    «Discovery Science HD PREMIUM+»

<p align="center">
  <a href="/tvlink/settings/04.png"><img src="/tvlink/settings/04.png" width="480"/></a>
</p>

{{% hint info %}}
Якщо в одному джерелі є канали, як показано вище, то найвищий пріоритет матиме потік (посилання на потік), назва якого найдовша,
тобто спочатку «Discovery Science HD PREMIUM+», потім «Discovery Science HD orig» і останнім «Discovery Science HD».
{{% /hint %}}

## «M3U playlist settings»

Дозволяє додати потрібні вам елементи після тегів «EXTM3U» та «EXTINF» у плейлісті «TVLINK».
Наприклад, це може бути інформація для періодичного оновлення списку каналів: «refresh="3600"». За умови, що ваш IPTV програвач це підтримує.

## Налаштування потоків

<p align="center">
  <a href="/tvlink/settings/05.png"><img src="/tvlink/settings/05.png" width="480"/></a>
</p>

+ «Main User-Agent» – задає User-Agent за замовчуванням. У деяких IPTV-провайдерів може бути блокування за User-Agent.
Вони надають потік лише якщо запит надходить від визначеної програми. Ви можете вказати «TVLINK», щоб він видавав себе за іншу програму.

Наступні налаштування здебільшого стосуються модуля «Streamlink» і відповідають за роботу з потоками.

+ «Stream Ring buffer» – задає розмір буфера для потоків (у мегабайтах).
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-ringbuffer-size">«ringbuffer-size»</a> в «Streamlink».

+ «Chunk size» – задає розмір фрагмента під час читання потоку (у байтах). Чим більший розмір фрагмента, то менше навантаження на процесор.
Чим менший розмір фрагмента, тим швидше відкривається потік.

+ «Threads job timeout» – час (у секундах), через який буде припинено роботу ланцюжка з читання/запису фрагментів потоку.
Частково відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-stream-timeout">«stream-timeout»</a> у «Streamlink».

+ «General HTTP timeout Connect/Data» – загальний тайм-аут (у секундах), який використовується для всіх HTTP-запитів, окрім тих, що охоплюються іншими параметрами.
Для розуміння: в HLS-потоках це буде тайм-аут для отримання списку сегментів. Окремо встановлюється час (тайм-аут) для підключення та час на отримання даних відповідно.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-http-timeout">«http-timeout»</a> у «Streamlink»,
окрім того, що дає змогу встановити різні значення для з’єднання та читання даних.

+ «HLS segment timeout Connect/Data» – тайм-аут (у секундах), який використовується для HLS-сегментів (а також DASH тощо).
Окремо встановлюється час (тайм-аут) для підключення та час на отримання даних відповідно.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-stream-segment-timeout">«stream-segment-timeout»</a> у «Streamlink»,
окрім того, що дає змогу встановити різні значення для з’єднання та читання даних.

+ «HLS segment queue threshold» – коефіцієнт множення цільової тривалості списку відтворення HLS, після якого потік буде зупинено достроково,
якщо після оновлення списку відтворення до черги не буде додано нових сегментів.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-segment-queue-threshold">«hls-segment-queue-threshold»</a> у «Streamlink».

+ «Stream retry count» – ця опція встановлює параметри <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-stream-segment-attempts">«stream-segment-attempts»</a>
та <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-playlist-reload-attempts">«hls-playlist-reload-attempts»</a> для «Streamlink».
Тобто кількість спроб завантаження для сегментів та списку сегментів.

+ «Segment threads» – кількість паралельних завантажень сегментів. Це розмір пулу потоків, який використовується для завантаження сегментів.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-stream-segment-threads">«stream-segment-threads»</a> у «Streamlink».

+ «Segments Queue» – розмір черги сегментів. У «Streamlink» вона є сталою – 20 сегментів. Але це забагато для Live-потоків.
Чим менша черга, тим скоріше закриватимуться потоки, а також буде менше споживання оперативної пам’яті та кількості відкритих сокетів.
Краще встановити «as threads», тобто відповідає кількості «Segment threads», але не менше ніж 6 сегментів.

+ «HLS live edge» – задає, скільки HLS-сегментів потрібно завантажити під час старту потоку.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-live-edge">«hls-live-edge»</a> у «Streamlink».

+ «HLS playlist reload time» – контролює час, через який виконується запит для оновлення списку сегментів.
Частково відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-playlist-reload-time">«hls-playlist-reload-time»</a> у «Streamlink».
Параметр «segment» має таке ж значення, як і в «Streamlink». Значення «duration» відповідає «default» у «Streamlink». Значення «average» – це середній час двох сегментів.
Значення «default» – це або одне зі значень, яким відповідають «duration» / «segment», або, якщо їх немає, встановлено час – 6 секунд.

+ «HLS Stream Data» – якщо активовано, негайно передає дані із сегмента до вихідного буфера під час завантаження. Канали відкриваються швидко, без попередньої буферизації перед стартом.
Якщо вимкнено, дані передаються лише після завантаження першого сегмента.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-segment-stream-data">«hls-segment-stream-data»</a> у «Streamlink».

+ «HLS Live Restart» – якщо активовано, переходити до початку прямої трансляції або якомога далі назад.
Відповідає параметру <a target='_blank' href="https://streamlink.github.io/cli.html#cmdoption-hls-live-restart">«hls-live-restart»</a> у «Streamlink».

+ «Debug Streams» – додає журнал роботи модуля «Streamlink» до журналу роботи «TVLINK». Файл журналу роботи знаходиться в каталозі «tvlink/log».

+ «Sources Proxy» та «Streams Proxy» – дозволяють встановити проксі для джерел та потоків. Формат: «http://login:password@your.proxy:port».
Значення «login/password» необов’язкові. Підтримуються протоколи: http, https, socks5.

## Налаштування потоків для окремих джерел

<p align="center">
  <a href="/tvlink/settings/06.png"><img src="/tvlink/settings/06.png" width="480"/></a>
</p>

Такі налаштування потоків, як:

+ Threads job timeout
+ General HTTP timeout
+ HLS segment timeout
+ HLS segment queue threshold
+ Stream retry count
+ HLS live edge
+ HLS Stream Data
+ HLS Live Restart

можна встановити окремо для кожного джерела на сторінці «Sources» (іконка біля назви джерела). При цьому не потрібно натискати на «Apply Settings», зміни набувають чинності одразу.

Ці самі параметри не потребують перезавантаження і на сторінці «Settings».

Кнопка «Default» у формі «Streamer settings» повертає всі окремі налаштування потоків для джерела до основних налаштувань на сторінці «Settings».

+ Playlist URL – дає можливість змінити URL-адресу джерела.

+ User-Agent – дає можливість встановити опцію «User-Agent» для кожного джерела (потоків у цьому джерелі) окремо. Підміняє собою опцію «Main User-Agent».

+ «Disable load icons» — вимикає отримання іконок каналів із джерела. На деяких джерелах можуть бути вказані недійсні адреси іконок.
Це призводить до затримки (залежить від вашого браузера) відображення списків каналів у веб-інтерфейсі програми.

+ «Repeat source streams» — дозволяє встановити кількість повторів програвання потоку під час збоїв. Ця опція не має стосунку до Streamlink-опції «Stream retry count».
Значення «always» означає, що повтори не обмежені, «0» — функцію вимкнено (за замовчуванням), інші значення — це кількість повторів.

{{% hint info %}}
Якщо ваш канал має лише один потік і цей потік хоч якось працює, «TVLINK» нескінченно намагатиметься перезапустити цей потік.
Функція «Repeat source streams» робить те саме для джерела (потоку цього джерела) каналу, де більше ніж один потік.
Таким чином, переключення на наступний потік цього каналу відбудеться за умови: або потік зовсім перестав працювати,
або за вибраною вами кількістю повторів. Якщо вибрано «always» — то тільки якщо потік перестав хоч щось віддавати.
{{% /hint %}}

Зміни в налаштуваннях цих полів відбуваються одразу після втрати фокуса.

## Пояснення щодо налаштування роботи потоків

Спочатку визначимо відмінності між тайм-аутами з’єднання та читання даних (Connect timeout і Read Data timeout).

+ «Connect timeout» (час очікування підключення)

Коли клієнт (у цьому випадку TVLINK є клієнтом по відношенню до сервера, звідки він запитує потоки) ініціалізує з’єднання, він повинен отримати відповідь від сервера (спеціальний код відповіді).
Не має значення, якою саме буде відповідь сервера. Це може бути відповідь 200 (підключення встановлено), 302 (переадресація) або будь-яка інша, головне, щоб сервер відповів.
Якщо протягом часу, зазначеного в тайм-ауті з’єднання (часі очікування підключення), відповідь від сервера не надійде, клієнт розриває з’єднання.

+ «Read Data timeout» (час очікування читання даних)

Коли клієнт отримує відповідь 200 (підключення встановлено) від сервера, він починає завантажувати (читати) дані, які передає сервер.
Якщо протягом часу, вказаного в тайм-ауті читання даних (часі очікування читання даних), сервер не передасть інформацію, клієнт розриває з’єднання.

Тепер визначимося з форматами потоків.

Найбільш поширені з них: TS та HLS.

+ «TS»

По суті, це те саме, якби ви завантажували будь-який файл у браузері. Клієнт робить запит і, якщо отримує відповідь 200, просто послідовно отримує дані.
Дані передаються в одному потоці, і якщо виникають проблеми з трафіком, це спричиняє проблеми і з відтворенням відео.
Тобто для IPTV через інтернет це не найкраще рішення. Воно більше підходить для локальної мережі.

+ «HLS»

Це той самий «TS» (спрощено кажучи), але розрізаний на фрагменти (сегменти).
Завдяки тому, що ці сегменти є вже записаними файлами (на відміну від TS, які передаються в реальному часі) і їх є кілька, клієнт має можливість одночасно завантажувати декілька сегментів.
Це, своєю чергою, допомагає боротися з проблемами трафіку і, відповідно, краще підходить для IPTV через інтернет.

Тепер безпосередньо про параметри «TVLINK».

+ «General HTTP timeout Connect/Data»

Якщо у вас TS-потік, саме ці тайм-аути будуть застосовуватися. Тайм-аути «HLS segment» не використовуватимуться для таких потоків.
Якщо у вас HLS-потік, тайм-аути «General HTTP» працюватимуть під час отримання плейлистів зі списком сегментів або варіантів якості потоків
(провайдер може надавати кілька варіантів якості потоків для різних швидкостей з’єднання). Плейлистами ми називаємо текстові файли,
які містять посилання на інші плейлисти (наприклад, якщо це список якості потоків) або посилання на відеосегменти.

+ «HLS segment timeout Connect/Data»

Ці тайм-аути застосовуються безпосередньо до сегментів (відеофайлів). Хоча в назві цього параметра зазначено «HLS», ці тайм-аути також працюють з іншими форматами сегментованих потоків, наприклад, «DASH».

У простому випадку (без списку якості потоків) для HLS-потоків це виглядатиме так:

+ отримання списку сегментів – «General HTTP timeout»
+ завантаження сегмента 1 – «HLS segment timeout»
+ завантаження сегмента 2 – «HLS segment timeout»
+ завантаження сегмента 3 – «HLS segment timeout»
+ отримання нового списку сегментів – «General HTTP timeout»
+ завантаження сегмента 4 – «HLS segment timeout»
+ завантаження сегмента 5 – «HLS segment timeout»
+ завантаження сегмента 6 – «HLS segment timeout»
+ отримання нового списку сегментів – «General HTTP timeout»

і так далі…

+ «HLS segment queue threshold»

Цей параметр (тайм-аут) також належить до HLS-потоків. Список HLS-сегментів (плейлист) містить змінну, де вказано тривалість відео в сегменті.
Ця змінна використовується «TVLINK» для визначення часу, через який потрібно запросити новий файл сегментів. Сервер постійно оновлює цей список одразу після завершення запису нового сегмента.
«HLS segment queue threshold» це число, на яке помножується змінна тривалості сегмента. Якщо протягом часу, отриманого в результаті множення, список сегментів на сервері не оновиться, клієнт розірве з’єднання.
Наприклад, у списку зазначено, що тривалість сегмента становить 6 секунд. Якщо значення «HLS segment queue threshold» дорівнює трьом, клієнт розірве з’єднання через 18 секунд, якщо на сервері не з’явиться новий сегмент.

+ «Threads job timeout»

Це тайм-аут внутрішнього циклу «Streamlink», який зчитує дані з вхідного потоку та записує їх у вихідний потік.
Якщо протягом зазначеного часу через цикл не проходять дані, він припиняє роботу, що призводить до закриття будь-якого з’єднання.

+ «Stream retry count»

Це кількість повторних спроб з’єднання у разі спрацьовування тайм-аутів «General HTTP» та «HLS segment».

## FFmpeg transcode stream

Якщо у вашій системі встановлено «FFmpeg», ви маєте можливість увімкнути модуль «FFmpeg transcode stream».

<p align="center">
  <a href="/tvlink/settings/07.png"><img src="/tvlink/settings/07.png" width="480"/></a>
</p>

Опції – це параметри командного рядка FFmpeg. Призначення полів:

+ «Before input» – параметри для апаратного транскодування
+ «Video encoder» – параметри відеокодера
+ «Audio encoder» – параметри аудіокодера

Щоб було зрозуміло, як саме ці параметри будуть вставлені в командний рядок «FFmpeg», ось приклад (спрощена схема):

    /usr/bin/ffmpeg -err_detect ignore_err -stream_loop -1 [Before input] -i http://channel.stream -c:v [Video encoder] -c:a [Audio encoder] -ignore_unknown -map 0:v -map 0:a -f mpegts

За замовчуванням поля «Video encoder» та «Audio encoder» містять параметр “copy”. Тобто якщо ці поля залишаються порожніми, буде встановлено значення “copy” (пропускати потік без перекодування).

Перед тим як встановлювати значення, переконайтеся, що «FFmpeg» у вашій системі підтримує відповідні параметри. Наприклад, виконайте команду:

    ffmpeg -hide_banner -encoders

щоб переглянути доступні аудіо- та відеокодери.

Якщо процесор у вашій системі (наприклад, Intel Pentium N5000) підтримує апаратне кодування потоків, можна застосувати, наприклад, такі налаштування.

«Before input»:

    -hwaccel vaapi -hwaccel_output_format vaapi -hwaccel_device /dev/dri/renderD128

«Video encoder»:

    h264_vaapi -r 50

«Audio encoder»:

    aac -b:a 96k

Після застосування налаштувань («Apply Settings»), на сторінці «About» з’явиться посилання на «M3U FFmpeg Playlist» (формат: http://ip-address:port/ffmpeglist).

<p align="center">
  <a href="/tvlink/settings/09.png"><img src="/tvlink/settings/09.png" width="480"/></a>
</p>

Увімкнення «FFmpeg transcode stream» не впливає на основний модуль трансляції. Вони працюють паралельно. Ви можете одночасно підключати одних клієнтів до звичайного плейлиста (playlist),
а інших – до плейлиста «FFmpeg» (ffmpeglist).

{{% hint info %}}
За посиланням «http://ip-address:port/ffmpeglist» ви завжди можете отримати плейлист, навіть якщо «FFmpeg transcode stream» вимкнено і в системі немає «FFmpeg». Тому будьте уважні.
{{% /hint %}}

Якщо увімкнути «Debug Streams» та запустити «TVLINK» з командного рядка, при зупинці потоку буде виведено інформацію від «FFmpeg» (параметри кодування, помилки тощо).

## Оновлення EPG

<p align="center">
  <a href="/tvlink/settings/08.png"><img src="/tvlink/settings/08.png" width="480"/></a>
</p>

Ці налаштування відповідають за періодичне оновлення «EPG».

+ «Auto update EPG» – увімкнути/вимкнути автоматичне періодичне оновлення EPG.

+ «Update period EPG» – вибрати зі списку період оновлення в годинах або один раз на добу (вночі).
